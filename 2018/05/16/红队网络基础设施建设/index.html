<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="icon" href="/favicon.ico">
  <title>MyKings</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox-1.3.4.css">
  <script src="https://cdn.staticfile.org/jquery/1.7/jquery.min.js" type="text/javascript" ></script>
</head>

<body>
	<header class="site-header navfixed-false">
  <div class="container">
      <h1><a href="/" title="MyKings"><span class="octicon octicon-mark-github"></span> MyKings</a></h1>
      <nav class="site-header-nav" role="navigation">
        
              
              <a href="/"  class=" site-header-nav-item hvr-underline-from-center" title="首页">首页</a>
        
              
              <a href="/categories/"  class=" site-header-nav-item hvr-underline-from-center" title="分类">分类</a>
        
              
              <a href="/open-source/"  class=" site-header-nav-item hvr-underline-from-center" title="开源项目">开源项目</a>
        
      </nav>
  </div>
</header>

	
<section class="collection-head geopattern" data-pattern-id="红队网络基础设施建设" >
    <div class="container">
        <div class="collection-title">
            <h1 class="collection-header">
                红队网络基础设施建设
            </h1>
            
                <div class="collection-info">
                    <span class="meta-info">
                        <span class="octicon octicon-calendar"></span>
                        <time datetime="2018-05-16T02:44:01.000Z" itemprop="datePublished">2018-05-16</time>
                    </span>
                    
                        <span class="meta-info">
                            <span class="octicon octicon-file-directory"></span>
                            <a href='/categories/翻译/' title=''>翻译</a>
                        </span>
                    
                </div>
            
        </div>
    </div>
</section>
	<section class="container">
    <div class="columns">
        <!-- -->
        <div class="column three-fourths">
            <article class="article-content markdown-body">
                <ul>
<li>设计注意事项 (Design Considerations)<ul>
<li>功能分离 (Functional Segregation)</li>
<li>使用转向器 (Using Redirectors)</li>
<li>设计举例 (Sample Design)</li>
<li>更多资源 (Further Resources)</li>
</ul>
</li>
<li>域名 (Domains)<ul>
<li>分类和黑名单检查资源列表 (Categorization and Blacklist Checking Resources)</li>
</ul>
</li>
<li>钓鱼 (Phishing)<ul>
<li>基于 Web 的钓鱼 (Easy Web-Based Phishing)</li>
<li>Cobalt Strike 钓鱼 (Cobalt Strike Phishing)</li>
<li>网络钓鱼框架 (Phishing Frameworks)</li>
</ul>
</li>
</ul>
<a id="more"></a>
<ul>
<li>转向器 (Redirectors)<ul>
<li>SMTP 协议 (SMTP)<ul>
<li>Sendmail 软件 (Sendmail)<ul>
<li>移除之前的服务器头 (Remove previous server headers)</li>
<li>配置一个通用地址 (Configure a catch-all address)</li>
</ul>
</li>
<li>Postfix 软件 (Postfix)</li>
</ul>
</li>
<li>DNS 协议 (DNS)<ul>
<li>socat 之 DNS (socat for DNS)</li>
<li>iptables 之 DNS (iptables for DNS)</li>
</ul>
</li>
<li>HTTP[S] 协议 (HTTP[S])<ul>
<li>socat 与 mod_rewrite (socat vs mod_rewrite)</li>
<li>socat 之 HTTP (socat for HTTP)</li>
<li>iptables 之 HTTP (iptables for HTTP)</li>
<li>ssh 之 HTTP (ssh for HTTP)</li>
<li>Payloads 和 Web 重定向 (Payloads and Web Redirection)</li>
<li>C2 重定向 (C2 Redirection)<ul>
<li>C2 使用 HTTPS 重定向 (C2 with HTTPS)</li>
</ul>
</li>
<li>其他 Apache mod_rewrite 资源 (Other Apache mod_rewrite Resources)</li>
</ul>
</li>
</ul>
</li>
<li>修改 C2 流量 (Modifying C2 Traffic)<ul>
<li>Cobalt Strike</li>
<li>Empire</li>
</ul>
</li>
<li>第三方 C2 频道 ([Third-Party C2 Channels)<ul>
<li>Domain Fronting 技术 (Domain Fronting)<ul>
<li>Domain Fronting 更多参考 (Further Resources on Domain Fronting)</li>
</ul>
</li>
<li>PaaS 重定向 (PaaS Redirectors)</li>
<li>其他第三方 C2 (Other Third-Party C2)</li>
</ul>
</li>
<li>隐蔽基础设施 (Obscuring Infrastructure)</li>
<li>保护基础设施 (Securing Infrastructure)</li>
<li>自动部署 (Automating Deployments)</li>
<li>提示&amp;建议 (General Tips)</li>
<li>感谢列表 (Thanks to Contributors)</li>
</ul>
<h1 id="一、设计注意事项"><a href="#一、设计注意事项" class="headerlink" title="一、设计注意事项"></a>一、设计注意事项</h1><h2 id="1-1-功能分离"><a href="#1-1-功能分离" class="headerlink" title="1.1 功能分离"></a>1.1 功能分离</h2><p>在设计红队的网络基础设施架构时，要考虑到否能够提供长期（数周、数月、数年）和稳定的响应服务，这要根据功能来拆分每个资产服务，这一点非常重要。当网络对抗中的资产服务被(蓝队)发现时，将会造成对方的警觉。 而功能分离的好处是当红队的网络钓鱼电子邮件评估系统被识别出来时，红队只需要重新创建一个新的<code>SMTP</code>服务器和<code>Payload</code>主机即可，而不是重新搭建整套网络的基础设施。</p>
<p><strong>在不同资产(服务器)上分离这些功能：</strong></p>
<ul>
<li>SMTP 钓鱼</li>
<li>钓鱼使用的 Payloads</li>
<li>长期的 C2(Command and Control)</li>
<li>短期的 C2(Command and Control)</li>
</ul>
<p>每次社工活动都可能需要这些功能，由于红队具有主动出击的特性，所以每一次活动都需要重新部署一套新的基础设施(功能资产模块化)。</p>
<h2 id="1-2-使用转向器"><a href="#1-2-使用转向器" class="headerlink" title="1.2 使用转向器"></a>1.2 使用转向器</h2><p>为了进一步提高系统弹性和隐蔽性，每个后端资产(即团队服务器)都应该在其前面放置一个转向器(redirector)。 这样的目的是保证目标和我们的后端服务器之间间接的建立连接。 这种方式有两种好处：1.是能够解耦各个功能资产服务；2.是能够达到隐蔽效果。当某一个资产服务被蓝队发现时，无需部署整套后端服务，便可进行迁移会话、重连接后端的未焚毁的资产等。</p>
<p><strong>常见的转向器(redirector)类型:</strong></p>
<ul>
<li>SMTP</li>
<li>Payloads</li>
<li>Web 流量</li>
<li>C2 (HTTP[S]、DNS、等)</li>
</ul>
<p>每个转向器(redirector)类型都有多个最适合不同场景的实现选项。 这些选项将在本文的”转向器”部分进一步详细讨论。 这里的转向器(redirector)可以是<code>VPS</code>主机、专用服务器、甚至是在 <code>PaaS</code> 上运行的应用程序。</p>
<h2 id="1-3-设计举例"><a href="#1-3-设计举例" class="headerlink" title="1.3 设计举例"></a>1.3 设计举例</h2><p>下面这个样例，使用了功能分离和转向器(redirector)的设计思路。其中<code>LT DNS C2</code>代表长期的 DNS C2 服务； <code>ST DNS C2</code>代表短期的 DNS C2 服务；<code>ST HTTP C2</code> 代表短期的 HTTP C2 服务。</p>
<p><img src="/images/redteam-infrastructure/sample-setup.png" alt="Sample Infrastructure Setup"></p>
<h2 id="1-4-更多资源"><a href="#1-4-更多资源" class="headerlink" title="1.4 更多资源"></a>1.4 更多资源</h2><ul>
<li><p><a href="https://blog.cobaltstrike.com/2013/02/12/a-vision-for-distributed-red-team-operations/" target="_blank" rel="noopener">A Vision for Distributed Red Team Operations - Raphael Mudge (@armitagehacker)</a></p>
</li>
<li><p><a href="https://blog.cobaltstrike.com/2014/09/09/infrastructure-for-ongoing-red-team-operations/" target="_blank" rel="noopener">Infrastructure for Ongoing Red Team Operations - Raphael Mudge</a></p>
</li>
<li><p><a href="https://www.youtube.com/watch?v=3gBJOJb8Oi0" target="_blank" rel="noopener">Advanced Threat Tactics (2 of 9): Infrastructure - Raphael Mudge</a></p>
</li>
<li><p><a href="https://blog.cobaltstrike.com/2014/01/14/cloud-based-redirectors-for-distributed-hacking/" target="_blank" rel="noopener">Cloud-based Redirectors for Distributed Hacking - Raphael Mudge</a></p>
</li>
<li><p><a href="https://cybersyndicates.com/2016/11/top-red-team-tips/" target="_blank" rel="noopener">6 Red Team Infrastructure Tips - Alex Rymdeko-Harvey (@killswitch-gui)</a></p>
</li>
<li><p><a href="https://www.blackhillsinfosec.com/build-c2-infrastructure-digital-ocean-part-1/" target="_blank" rel="noopener">How to Build a C2 Infrastructure with Digital Ocean – Part 1 - Lee Kagan (@invokethreatguy)</a></p>
</li>
<li><p><a href="https://rastamouse.me/2017/08/automated-red-team-infrastructure-deployment-with-terraform---part-1/" target="_blank" rel="noopener">Automated Red Team Infrastructure Deployment with Terraform - Part 1 - Rasta Mouse (@_RastaMouse)</a></p>
</li>
</ul>
<h1 id="二、域名"><a href="#二、域名" class="headerlink" title="二、域名"></a>二、域名</h1><p>根据目标所使用的产品及其构造，来选择具有迷惑性的域名至关重要。 由于，选择一个适用于你目标的域名是非常繁琐和“无规矩”可寻的。OSINT(开源情报收集)可以更好的帮助推测管理所需要的资源，这个很重要（开源情报的重要与便利性）。 庆幸的是域名商也需要知道域名的状态与资产信息，并且他们提供了一些查询接口，这也会我们创建了一些便利的条件。</p>
<p><a href="http://expireddomains.net" target="_blank" rel="noopener">expireddomains.net</a> 是一个收集最近过期或已丢弃域名的引擎。 它提供了搜索和高级过滤，例如：到期时间、反向链接数量、archive.org快照数量、<a href="https://www.similarweb.com/" target="_blank" rel="noopener">SimilarWeb</a> 分数。 使用 SimilarWeb 网站，我们可以注册预先使用的域，这些域将与目标域名的年份相同，会使它看起来与我们的目标域类似，使他融入我们的目标网络来迷惑对手。</p>
<p><img src="/images/redteam-infrastructure/expired-domains.png" alt="expireddomains.net"></p>
<p>在为 C2 或数据回传选择域时，请优先考虑“财务”或“医疗保健”域的分类。由于法律或数据敏感性问题原因，许多组织不会在这些分类中执行 SSL 中间人。请确保你选择的域名与之前的任何恶意软件或网络钓鱼系列没有关联也很重要。</p>
<p>Charles Hamilton(<a href="https://twitter.com/mrun1k0d3r" target="_blank" rel="noopener">@ MrUn1k0d3r</a>)的工具<a href="https://github.com/Mr-Un1k0d3r/CatMyFish" target="_blank" rel="noopener">CatMyFish</a>会自动执行 <code>expireddomains.net</code> 的搜索，并且会使用<code>bluecoat.com</code>来检查网站的所属分类。你可以对过滤器进行修改，以便搜索更多内容，你还可以利用它来长期监控你的注册资产(域名资产)。</p>
<p>Joe Vest(<a href="https://twitter.com/joevest" target="_blank" rel="noopener">@joevest</a>) 和 Andrew Chiles(<a href="http://twitter.com/andrewchiles" target="_blank" rel="noopener">@andrewchiles</a>)提供了另一个工具<a href="https://github.com/minisllc/domainhunter" target="_blank" rel="noopener">DomainHunter</a>，它会返回一个表格，主要内容包括 <code>BlueCoat</code>、<code>IBM X-Force</code>和<code>Cisco Talos</code>中查询出的分类，域名年龄、可用的TLDs、Archive.org链接和HTML报告等信息。 此外，它使用<code>malwaredomains.com</code>和<code>mxtoolbox.com</code>来检查域名是否存在已知的恶意软件和网络钓鱼活动，该工具还包括了绕过<code>BlueCoat/WebPulse</code>验证码的<code>OCR</code>功能(<a href="http://threatexpress.com/2017/03/leveraging-expired-domains-for-red-team-engagements/" target="_blank" rel="noopener">查看该工具更多详细信息</a>)。</p>
<p><img src="/images/redteam-infrastructure/domainhunter.jpg" alt="expireddomains.net"></p>
<p><em>（上图为译者提供）</em></p>
<p><a href="https://twitter.com/@Max_68" target="_blank" rel="noopener">Max Harle</a>的另一个工具<a href="https://github.com/t94j0/AIRMASTER" target="_blank" rel="noopener">AIRMASTER</a>使用 <code>expireddomains.net</code>和<code>Bluecoat</code>来查找域名的分类。该工具使用<code>OCR</code>绕过<code>BlueCoat</code>验证码来提高搜索速度。</p>
<p>如果以前注册的域名不可用(域名分类不正确或不理想)，或者使用自己注册的域名(域名没有进行分类)时，你可以克隆或重定向到一个相似分类的域名上，然后在手动提交你的域名分类。你可以使用<a href="https://twitter.com/domchell" target="_blank" rel="noopener">Dominic Chell</a>开发的<a href="https://github.com/mdsecactivebreach/Chameleon" target="_blank" rel="noopener">Chameleon</a>工具。大多数产品在确认域名的分类时，都会忽略重定向或克隆的网站内容。 有关Chameleon使用的更多信息，请查看Dominic的帖子<a href="https://www.mdsec.co.uk/2017/07/categorisation-is-not-a-security-boundary/" target="_blank" rel="noopener"> Categorisation is not a security boundary</a>。</p>
<p>最后，确保你的<code>DNS</code>设置正确, 这里可以借助 <a href="https://dnschecker.org/" target="_blank" rel="noopener">DNS Propogation Checker</a> 来检验。</p>
<h2 id="2-1-分类和黑名单检查资源列表"><a href="#2-1-分类和黑名单检查资源列表" class="headerlink" title="2.1 分类和黑名单检查资源列表"></a>2.1 分类和黑名单检查资源列表</h2><ul>
<li><a href="https://trustedsource.org/en/feedback/url?action=checksingle" target="_blank" rel="noopener">McAfee</a></li>
<li><a href="http://www.fortiguard.com/iprep" target="_blank" rel="noopener">Fortiguard</a></li>
<li><a href="http://sitereview.bluecoat.com/sitereview.jsp" target="_blank" rel="noopener">Symantec + BlueCoat</a></li>
<li><a href="https://www.checkpoint.com/urlcat/main.htm" target="_blank" rel="noopener">Checkpoint (requires free account)</a></li>
<li><a href="https://urlfiltering.paloaltonetworks.com/" target="_blank" rel="noopener">Palo Alto</a></li>
<li><a href="https://secure2.sophos.com/en-us/support/contact-support.aspx" target="_blank" rel="noopener">Sophos (submission only; no checking)</a> - Click Submit a Sample -&gt; Web Address</li>
<li><a href="https://global.sitesafety.trendmicro.com/" target="_blank" rel="noopener">TrendMicro</a></li>
<li><a href="http://www.brightcloud.com/tools/url-ip-lookup.php" target="_blank" rel="noopener">Brightcloud</a></li>
<li><a href="http://csi.websense.com/" target="_blank" rel="noopener">Websense (Forcepoint)</a></li>
<li><a href="https://archive.lightspeedsystems.com/" target="_blank" rel="noopener">Lightspeed Systems</a></li>
<li><a href="https://github.com/mdsecactivebreach/Chameleon" target="_blank" rel="noopener">Chameleon</a></li>
<li><a href="https://www.senderbase.org/" target="_blank" rel="noopener">SenderBase</a></li>
<li><a href="http://multirbl.valli.org/" target="_blank" rel="noopener">MultiBL</a></li>
<li><a href="https://mxtoolbox.com/blacklists.aspx" target="_blank" rel="noopener">MXToolBox - Blacklists</a></li>
</ul>
<h1 id="三、网络钓鱼设置"><a href="#三、网络钓鱼设置" class="headerlink" title="三、网络钓鱼设置"></a>三、网络钓鱼设置</h1><h2 id="3-1-基于-Web-的钓鱼"><a href="#3-1-基于-Web-的钓鱼" class="headerlink" title="3.1 基于 Web 的钓鱼"></a>3.1 基于 Web 的钓鱼</h2><p>简单操作和网络钓鱼似乎不可同时兼得，建立一个适当的网络钓鱼基础设施可能是一个非常痛苦的事。 这里将为你提供快速设置一个钓鱼服务器的知识和工具，该服务器可以绕过大多数垃圾邮件过滤器，并为你提供一个简单的网络钓鱼体验，包括与你的目标进行双向通信的<code>RoundCube</code>界面。 网上有很多设置网络钓鱼的方法，这里只是其中的一种。</p>
<p>一旦你的域名通过了上面的设置与检查，并且你的钓鱼服务器已启动，那么首先你需要为你的域名创建一条“A”记录，如图所示。</p>
<p><img src="/images/redteam-infrastructure/setup_dns_a_record_for_ssl.png" alt="DNS Setup"></p>
<p>接下来，进入你的钓鱼服务器并确保你的<code>/etc/hosts</code>中列出了正确的<code>FQDN</code>主机名。<br>示例: <code>127.0.0.1 mail.yourphishingserver.com mail localhost</code></p>
<p>现在，你只需几个简单的步骤即可安装网络前端来进行网络钓鱼。首先下载<a href="http://www.iredmail.org/download.html" target="_blank" rel="noopener">iRedMail</a>的最新版本到你的钓鱼服务器上，并解压<code>tar -xvf iRedMail-0.9.8.tar.bz2</code>。进入到解压后的文件夹，并为<code>iRedMail.sh</code>脚本添加可执行权限（<code>chmod +x iRedMail.sh</code>）以<code>root</code>用户身份执行脚本，按照提示操作，然后重新启动服务器。</p>
<p>你需要确保你的邮件服务器拥有所有正确的<code>DNS</code>记录（相关记录设置请参考<a href="https://docs.iredmail.org/setup.dns.html" target="_blank" rel="noopener">https://docs.iredmail.org/setup.dns.html</a>）。对于 DKIM（DomainKeys Identified Mail，域名密钥识别邮件）使用命令<code>amavisd-new showkeys</code>来列出你的<code>DKIM</code>密钥。</p>
<p><img src="/images/redteam-infrastructure/dkim.jpg" alt="DKIM"></p>
<p><em>（上图为译者提供）</em></p>
<p>对于<code>DMARC</code>(Domain-based Message Authentication Reporting and Conformance, 基于域的消息认证报告一致性)我们可以使用<a href="https://www.unlocktheinbox.com/dmarcwizard/" target="_blank" rel="noopener">https://www.unlocktheinbox.com/dmarcwizard/</a>在线生成我们的<code>DMARC</code>条目。</p>
<p><img src="/images/redteam-infrastructure/iredadmin_dashboard.png" alt="iRedMail Dashboard"></p>
<p>现在，创建一个用户进行钓鱼。</p>
<p><img src="/images/redteam-infrastructure/iredadmin_user_add.png" alt="iRedMail Create User"></p>
<p>登录到<code>RoundCube</code>界面, 使用新用户开始钓鱼吧！</p>
<p><img src="/images/redteam-infrastructure/roundcube_login.png" alt="RoundCube Login"></p>
<p><img src="/images/redteam-infrastructure/final_phish_away.png" alt="RoundCube Send Mail"></p>
<h2 id="3-2-Cobalt-Strike-钓鱼"><a href="#3-2-Cobalt-Strike-钓鱼" class="headerlink" title="3.2 Cobalt Strike 钓鱼"></a>3.2 Cobalt Strike 钓鱼</h2><p><code>Cobalt Strike</code>提供可自定义的钓鱼功能来帮助<code>Pentest(渗透测试)</code>和红队。它支持 HTML 和纯文本(plaintext)格式的模板、附件、反弹地址、URL 嵌入、使用远程 SMTP 服务器以及每条消息延迟发送。你还可以为每个用户嵌入的 URL 添加唯一标记以进行点击跟踪。</p>
<p><img src="/images/redteam-infrastructure/cobalt-strike-phishing-popup.png" alt="Cobalt Strike Spearphishing Popup"></p>
<p>有关更多详细信息，请查看以下资源：</p>
<ul>
<li><a href="https://www.cobaltstrike.com/help-spear-phish" target="_blank" rel="noopener">Cobalt Strike - Spear Phishing documentation</a></li>
<li><a href="https://blog.cobaltstrike.com/2014/12/17/whats-the-go-to-phishing-technique-or-exploit/" target="_blank" rel="noopener">Cobalt Strike Blog - What’s the go-to phishing technique or exploit?</a></li>
<li><a href="https://www.youtube.com/watch?v=V7UJjVcq2Ao" target="_blank" rel="noopener">Spear phishing with Cobalt Strike - Raphael Mudge</a></li>
<li><a href="https://www.youtube.com/watch?v=CxQfWtqpwRs" target="_blank" rel="noopener">Advanced Threat Tactics (3 of 9) - Targeted Attacks - Raphael Mudge</a></li>
</ul>
<h2 id="3-3-网络钓鱼框架"><a href="#3-3-网络钓鱼框架" class="headerlink" title="3.3 网络钓鱼框架"></a>3.3 网络钓鱼框架</h2><p>除了搭建自己的网络钓鱼服务外，还有许多像<code>Cobalt Strike</code>这种专用于电子邮件钓鱼的工具和框架。这篇文章不会详细介绍每个框架，但下面提供了一些参考资料：</p>
<h3 id="3-3-1-Gophish"><a href="#3-3-1-Gophish" class="headerlink" title="3.3.1 Gophish"></a>3.3.1 Gophish</h3><ul>
<li><a href="https://getgophish.com/" target="_blank" rel="noopener">Gophish Official Site</a></li>
<li><a href="https://github.com/gophish/gophish" target="_blank" rel="noopener">Gophish GitHub Repo</a></li>
<li><a href="https://www.gitbook.com/book/gophish/user-guide/details" target="_blank" rel="noopener">Gophish User Guide</a></li>
</ul>
<h3 id="3-3-2-Frenzy"><a href="#3-3-2-Frenzy" class="headerlink" title="3.3.2 Frenzy"></a>3.3.2 Frenzy</h3><ul>
<li><a href="https://www.phishingfrenzy.com/" target="_blank" rel="noopener">Phishing Frenzy Official Site</a></li>
<li><a href="https://github.com/pentestgeek/phishing-frenzy" target="_blank" rel="noopener">Phishing Frenzy GitHub Repo</a></li>
<li><a href="https://www.pentestgeek.com/phishing/introducing-phishing-frenzy" target="_blank" rel="noopener">Introducing Phishing Frenzy - Brandon McCann (@zeknox)</a></li>
</ul>
<h3 id="3-3-3-Social-Engineer-工具包"><a href="#3-3-3-Social-Engineer-工具包" class="headerlink" title="3.3.3 Social-Engineer 工具包"></a>3.3.3 Social-Engineer 工具包</h3><ul>
<li><a href="https://github.com/trustedsec/social-engineer-toolkit" target="_blank" rel="noopener">The Social-Engineer Toolkit GitHub Repo</a></li>
<li><a href="https://github.com/trustedsec/social-engineer-toolkit/raw/master/readme/User_Manual.pdf" target="_blank" rel="noopener">The Social-Engineer Toolkit User Manual</a></li>
</ul>
<h3 id="3-3-4-FiercePhish-formerly-FirePhish"><a href="#3-3-4-FiercePhish-formerly-FirePhish" class="headerlink" title="3.3.4 FiercePhish (formerly FirePhish)"></a>3.3.4 FiercePhish (formerly FirePhish)</h3><ul>
<li><a href="https://github.com/Raikia/FiercePhish" target="_blank" rel="noopener">FiercePhish GitHub Repo</a></li>
<li><a href="https://github.com/Raikia/FiercePhish/wiki" target="_blank" rel="noopener">FiercePhish Wiki</a></li>
</ul>
<h1 id="四、转向器"><a href="#四、转向器" class="headerlink" title="四、转向器"></a>四、转向器</h1><h2 id="4-1-SMTP-协议"><a href="#4-1-SMTP-协议" class="headerlink" title="4.1 SMTP 协议"></a>4.1 SMTP 协议</h2><p>“转向器(Redirector)”可能不是描述我们要实现此功能的最佳词语，但其目的与我们使用的其他重定向功能相同。 我们希望从最终的电子邮件头中删除钓鱼邮件的所有痕迹，并在受害者与我们的后端服务器之间提供缓冲区。 理想情况下<code>SMTP</code>转向器安装快速并易于停止。</p>
<p><strong>我们想要配置<code>SMTP</code>转向器来执行两个关键操作：</strong></p>
<h3 id="4-1-1-Sendmail-软件"><a href="#4-1-1-Sendmail-软件" class="headerlink" title="4.1.1 Sendmail 软件"></a>4.1.1 Sendmail 软件</h3><h4 id="移除之前的服务器头"><a href="#移除之前的服务器头" class="headerlink" title="移除之前的服务器头"></a>移除之前的服务器头</h4><p>将以下行添加到结尾 <code>/etc/mail/sendmail.mc</code>:</p>
<pre><code class="hljs c">define(`confRECEIVED_HEADER',`by $j ($v/$Z)$?r with $r$. id $i; $b')dnl</code></pre>

<p>添加到结尾 <code>/etc/mail/access</code>:</p>
<pre><code class="hljs c">IP-to-Team-Server *TAB* RELAY
Phish-Domain *TAB* RELAY
</code></pre>

<p><a href="https://www.devside.net/wamp-server/removing-senders-ip-address-from-emails-received-from-header" target="_blank" rel="noopener">Removing Sender’s IP Address From Email’s Received From Header</a></p>
<p><a href="https://major.io/2013/04/14/remove-sensitive-information-from-email-headers-with-postfix/" target="_blank" rel="noopener">Removing Headers from Postfix setup</a></p>
<h4 id="配置一个通用地址"><a href="#配置一个通用地址" class="headerlink" title="配置一个通用地址"></a>配置一个通用地址</h4><p>这会将会把收到的任何电子邮件转发到<code>*@phishdomain.com</code>到选定的电子邮件地址。这对于收到任何响应或反弹到钓鱼邮件非常有用。</p>
<pre><code class="hljs c">echo PHISH-DOMAIN >> /etc/mail/local-host-names
</code></pre>

<p>在<code>/etc/mail/sendmail.mc</code>的<code>//Mailer Definitions//</code>（结尾处）之前添加以下行：</p>
<pre><code class="hljs c">FEATURE(`virtusertable', `hash -o /etc/mail/virtusertable.db')dnl
</code></pre>

<p>将以下行添加到<code>/etc/mail/virtusertable</code>结尾:</p>
<pre><code class="hljs c">@phishdomain.com  external-relay-address
</code></pre>

<p><em>注意：这两个字段应该以制表符(\t)分隔</em></p>
<h3 id="4-1-2-Postfix-软件"><a href="#4-1-2-Postfix-软件" class="headerlink" title="4.1.2 Postfix 软件"></a>4.1.2 Postfix 软件</h3><p><code>Postfix</code>提供了一个更容易替代<code>Sendmail</code>而且提供了更好的兼容性。 <code>Postfix</code>还为<code>Dovecot</code>提供全面的<code>IMAP</code>支持。这使得测试人员能够实时地与对原始消息做出响应的钓鱼攻击目标相对应，而不是依靠全部通讯地址，并且必须使用钓鱼工具创建新消息。</p>
<p>Julian Catrambone’s(<a href="https://twitter.com/n0pe_sled" target="_blank" rel="noopener">@n0pe_sled</a>)提供了一个设置<code>Postfix</code>邮件服务器进行网络钓鱼的完整指南<a href="https://blog.inspired-sec.com/archive/2017/02/14/Mail-Server-Setup.html" target="_blank" rel="noopener">Mail Servers Made Easy</a>。</p>
<h2 id="4-2-DNS-协议"><a href="#4-2-DNS-协议" class="headerlink" title="4.2 DNS 协议"></a>4.2 DNS 协议</h2><p><img src="/images/redteam-infrastructure/dns_redirection.png" alt="Sample DNS Redirector Setup"></p>
<p>注意：使用 C2 转向器时，应在你的后渗透框架中配置外部侦听器，以通过转向器域发送分段流量。 这会使受感染的主机像 C2 流量本身一样分段通过转向器。</p>
<h3 id="4-2-1-socat-之-DNS"><a href="#4-2-1-socat-之-DNS" class="headerlink" title="4.2.1 socat 之 DNS"></a>4.2.1 socat 之 DNS</h3><p><code>socat</code>可用于将端口 53 上的传入<code>DNS</code>数据包重定向到我们的团队服务器, 此方法很有效。目前，某些用户已为 <code>Cobalt Strike</code> 提出了这个功能issues需求。</p>
<p>由于来自 @xorrior 的测试，以下 socat 命令似乎很好用：</p>
<pre><code class="hljs c">
socat udp4-recvfrom:53,reuseaddr,fork udp4-sendto:<ipaddress>; echo -ne
</ipaddress></code></pre>

<p><a href="http://www.rvrsh3ll.net/blog/offensive/redirecting-cobalt-strike-dns-beacons/" target="_blank" rel="noopener">Redirecting Cobalt Strike DNS Beacons - Steve Borosh</a></p>
<h3 id="4-2-2-iptables-之-DNS"><a href="#4-2-2-iptables-之-DNS" class="headerlink" title="4.2.2 iptables 之 DNS"></a>4.2.2 iptables 之 DNS</h3><p><code>iptables</code>转发<code>DNS</code>规则已被发现可与<code>Cobalt Strike</code>配合使用。 貌似<code>socat</code>暂时还处理不了这类流量的问题(NAT穿透)。</p>
<p>下面是一个<code>DNS</code>转向器规则集示例:</p>
<pre><code class="hljs c">iptables -I INPUT -p udp -m udp --dport 53 -j ACCEPT
iptables -t nat -A PREROUTING -p udp --dport 53 -j DNAT --to-destination <ip-goes-here>:53
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -I FORWARD -j ACCEPT
iptables -P FORWARD ACCEPT
sysctl net.ipv4.ip_forward=1
</ip-goes-here></code></pre>

<p>另外，将“FORWARD”链策略更改为“ACCEPT”。</p>
<h3 id="DNS重定向也可以在NAT后面完成"><a href="#DNS重定向也可以在NAT后面完成" class="headerlink" title="DNS重定向也可以在NAT后面完成"></a>DNS重定向也可以在NAT后面完成</h3><p>有时候可能需要在内部网络上托管<code>C2</code>服务器。 使用<code>iptables</code>、<code>socat</code>和反向<code>SSH</code>隧道的组合，我们可以通过以下方式实现这一点。</p>
<p><img src="/images/redteam-infrastructure/dns_nat.png" alt="Sample DNS NAT Setup"></p>
<p>在这种情况下，我们使用<code>iptables</code>转发所有<code>DNS</code>流量。 接下来，我们创建一个从我们的内部<code>C2</code>服务器到我们的主转向器的<code>SSH</code>反向端口转发隧道。 这会将主转向器在端口 6667 上接收的任何流量转发到端口 6667 上的内部<code>C2</code>服务器。现在，启动服务器上的<code>socat</code>将端口 6667 上的任何传入TCP流量分流到 UDP 端口 53 ，这就是我们的 DNS C2 需要监听。 最后，我们在主转向器上同样设置一个<code>socat</code>实例，将任何传入的 UDP 端口 53 流量重定向到端口 6667 上的SSH隧道。</p>
<h2 id="4-3-HTTP-S-协议"><a href="#4-3-HTTP-S-协议" class="headerlink" title="4.3 HTTP(S) 协议"></a>4.3 HTTP(S) 协议</h2><h3 id="4-3-1-socat-与-mod-rewrite"><a href="#4-3-1-socat-与-mod-rewrite" class="headerlink" title="4.3.1 socat 与 mod_rewrite"></a>4.3.1 socat 与 mod_rewrite</h3><p><code>socat</code>提供了<code>dumb pipe</code>重定向，在指定的源接口/port上接收到的任何请求都会被重定向到目标IP/port，但<code>socat</code>没有过滤或设置条件的功能。 <code>Apache</code>的<code>mod_rewrite</code>模块提供了许多方法来加强钓鱼攻击并增强测试基础架构的弹性。 <code>mod_rewrite</code>能够根据请求属性（如URI、User-Agent、请求参数、操作系统和IP）执行条件重定向。<code>Apache</code>的<code>mod_rewrite</code>使用<code>htaccess</code>文件来配置<code>Apache</code>应该如何处理每个传入请求的规则集。 例如:使用这些规则，你可以使用默认<code>wget</code>的<code>User-Agent</code>请求重定向到你的服务器，从而将其转到目标网站上的合法页面。</p>
<p>简而言之，如果你的转向器(redirector)需要执行条件重定向或高级过滤，请使用<code>Apache</code>的<code>mod_rewrite</code>。 也可使用<code>socat</code>重定向并<code>iptables</code>过滤。</p>
<h3 id="4-3-2-socat-之-HTTP"><a href="#4-3-2-socat-之-HTTP" class="headerlink" title="4.3.2 socat 之 HTTP"></a>4.3.2 socat 之 HTTP</h3><p><code>socat</code>可用于将指定端口上的任何传入 TCP 数据包重定向到你的服务器。将<code>localhost</code>上的 TCP 端口 80 重定向到另一台主机上的端口 80 的基本语法是：</p>
<pre><code class="hljs c">
socat TCP4-LISTEN:80,fork TCP4:<remote-host-ip-address>:80
</remote-host-ip-address></code></pre>
如果你的转向器配置了多个网络接口，则可以使用以下语法通过IP地址将`socat`绑定到特定接口：

<pre><code class="hljs c">
socat TCP4-LISTEN:80,bind=10.0.0.2,fork TCP4:1.2.3.4:80
</code></pre>

<p>在本例中<code>10.0.0.2</code>是转向器的本地 IP 中的一个，<code>1.2.3.4</code>是远程组服务器的 IP 地址。</p>
<h3 id="4-3-3-iptables-之-HTTP"><a href="#4-3-3-iptables-之-HTTP" class="headerlink" title="4.3.3 iptables 之 HTTP"></a>4.3.3 iptables 之 HTTP</h3><p>除了<code>socat</code>, <code>iptables</code>可以通过 NAT 执行<code>dumb pipe</code>重定向。 要将转向器的本地端口80转发到远程主机，配置命令如下：</p>
<pre><code class="hljs c">iptables -I INPUT -p tcp -m tcp --dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination <remote-host-ip-address>:80
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -I FORWARD -j ACCEPT
iptables -P FORWARD ACCEPT
sysctl net.ipv4.ip_forward=1
</remote-host-ip-address></code></pre>

<h3 id="4-3-4-SSH-之-HTTP"><a href="#4-3-4-SSH-之-HTTP" class="headerlink" title="4.3.4 SSH 之 HTTP"></a>4.3.4 SSH 之 HTTP</h3><p>我们之前已经介绍过使用<code>SSH</code>进行<code>DNS</code>隧道。 <code>SSH</code>作为一种坚实可靠的方式来突破<code>NAT</code>并获得种植体连接转向器和服务器环境的方式。 首先，你必须设置<code>GatewayPorts</code>转发，否则将无法正常使用：</p>
<pre><code class="hljs c">nano /etc/ssh/sshd_config</code></pre> add GatewayPorts yes

<p>要将转向器的本地端口 80 转发到你的内部服务器，命令如下：</p>
<pre><code class="hljs c">tmux new -S redir80
ssh <redirector> -R *:80:localhost:80
Ctrl+B, D
</redirector></code></pre>

<p><em>译者注：上面的命令第一和第三条非必须，这里作者使用<code>tmux</code>进行 Session 保持，<code>tmux new -S redir80</code>使用<code>tmux</code>开启一个 shell，<br><code>Ctrl+B, D</code>隐藏<code>tmux</code>操作界面, 使用<code>tmux ls</code>显示 Seesion。</em></p>
<p>你也可以转发多个端口，例如：如果希望 443 和 80 一次全部打开：</p>
<pre><code class="hljs c">tmux new -S redir80443
ssh <redirector> -R *:80:localhost:80 -R *:443:localhost:443
Ctrl+B, D
</redirector></code></pre>

<h3 id="4-3-5-Payloads-与-Web-重定向"><a href="#4-3-5-Payloads-与-Web-重定向" class="headerlink" title="4.3.5 Payloads 与 Web 重定向"></a>4.3.5 Payloads 与 Web 重定向</h3><p>当我们的<code>Payloads</code>(服务)和网络资源开启时，我们希望降低被检测到的风险，同时希望无论是建立<code>C2</code>还是收集信息<code>payload</code>都能被高效的执行。</p>
<p><img src="/images/redteam-infrastructure/apache-redirector-setup.png" alt="Sample Apache Redirector Setup"></p>
<p>下面是 Jeff Dimmock 关于<code>Apache</code>的<code>mod_rewrite</code>的用法和示例：</p>
<ul>
<li><a href="https://bluescreenofjeff.com/2016-03-22-strengthen-your-phishing-with-apache-mod_rewrite-and-mobile-user-redirection/" target="_blank" rel="noopener">Strengthen Your Phishing with Apache mod_rewrite</a></li>
<li><a href="https://bluescreenofjeff.com/2016-03-29-invalid-uri-redirection-with-apache-mod_rewrite/" target="_blank" rel="noopener">Invalid URI Redirection with Apache mod_rewrite</a></li>
<li><a href="https://bluescreenofjeff.com/2016-04-05-operating-system-based-redirection-with-apache-mod_rewrite/" target="_blank" rel="noopener">Operating System Based Redirection with Apache mod_rewrite</a></li>
<li><a href="https://bluescreenofjeff.com/2016-04-12-combatting-incident-responders-with-apache-mod_rewrite/" target="_blank" rel="noopener">Combatting Incident Responders with Apache mod_rewrite</a></li>
<li><a href="https://bluescreenofjeff.com/2016-04-19-expire-phishing-links-with-apache-rewritemap/" target="_blank" rel="noopener">Expire Phishing Links with Apache RewriteMap</a></li>
<li><a href="https://bluescreenofjeff.com/2016-12-23-apache_mod_rewrite_grab_bag/" target="_blank" rel="noopener">Apache mod_rewrite Grab Bag</a></li>
<li><a href="https://bluescreenofjeff.com/2017-06-13-serving-random-payloads-with-apache-mod_rewrite/" target="_blank" rel="noopener">Serving Random Payloads with Apache mod_rewrite</a></li>
</ul>
<p>其他<code>Apache</code>的<code>mod_rewrite</code>的用法和示例：</p>
<ul>
<li><p><a href="https://gist.github.com/curi0usJack/971385e8334e189d93a6cb4671238b10" target="_blank" rel="noopener">mod_rewrite rule to evade vendor sandboxes from Jason Lang @curi0usjack</a></p>
</li>
<li><p><a href="https://gist.github.com/jivoi/a33ace2e25515a31aa2ffbae246d98c9" target="_blank" rel="noopener">Serving random payloads with NGINX - Gist by jivoi</a></p>
</li>
</ul>
<p>要在服务器上自动设置<code>Apache</code>的<code>mod_rewrite</code>重定向器，请查看 Julain Catrambone’s（<a href="https://twitter.com/n0pe_sled" target="_blank" rel="noopener">@ n0pe_sled</a>) 博客文章<a href="https://blog.inspired-sec.com/archive/2017/04/17/Mod-Rewrite-Automatic-Setup.html" target="_blank" rel="noopener">Mod_Rewrite Automatic Setup</a> 和 <a href="https://github.com/n0pe-sled/Apache2-Mod-Rewrite-Setup" target="_blank" rel="noopener">accompanying tool</a>。</p>
<h3 id="4-3-6-C2-重定向"><a href="#4-3-6-C2-重定向" class="headerlink" title="4.3.6 C2 重定向"></a>4.3.6 C2 重定向</h3><p>重定向 C2 流量的意图有两方面：隐藏后端服务器；蒙蔽相关的调查者，让他们以为这是个合法网站。 通过使用<code>Apache</code>的<code>mod_rewrite</code>和<a href="＃modification-c2-traffic">自定义C2配置文件</a>或其他代理（比如使用Flask），我们可以高效的过滤出来自调查 C2 的真实流量。</p>
<ul>
<li><a href="https://bluescreenofjeff.com/2016-06-28-cobalt-strike-http-c2-redirectors-with-apache-mod_rewrite/" target="_blank" rel="noopener">Cobalt Strike HTTP C2 Redirectors with Apache mod_rewrite - Jeff Dimmock</a></li>
<li><a href="https://thevivi.net/2017/11/03/securing-your-empire-c2-with-apache-mod_rewrite/" target="_blank" rel="noopener">Securing your Empire C2 with Apache mod_rewrite - Gabriel Mathenge (@_theVIVI)</a></li>
<li><a href="https://cybersyndicates.com/2017/04/expand-your-horizon-red-team/" target="_blank" rel="noopener">Expand Your Horizon Red Team – Modern SAAS C2 - Alex Rymdeko-Harvey (@killswitch-gui)</a></li>
<li><a href="https://zachgrace.com/2018/02/20/cobalt_strike_redirectors.html" target="_blank" rel="noopener">Hybrid Cobalt Strike Redirectors</a> - <a href="https://twitter.com/ztgrace" target="_blank" rel="noopener">Zach Grace (@ztgrace)</a> and <a href="https://twitter.com/m0ther_" target="_blank" rel="noopener">@m0ther_</a></li>
</ul>
<h4 id="C2-使用-HTTPS-重定向"><a href="#C2-使用-HTTPS-重定向" class="headerlink" title="C2 使用 HTTPS 重定向"></a>C2 使用 HTTPS 重定向</h4><p>基于上述 “C2重定向”，另一种方法是可以在重定向服务器使用<code>Apache</code>的<code>SSL</code>代理引擎来接受入站<code>SSL</code>请求，并将这些请求代理到<code>HTTPS</code>反向侦听器上。 整个阶段使用加密，你可以根据需要在转向器上转发<code>SSL</code>证书。</p>
<p>假如你已经使用了LetsEncrypt（aka CertBot），为了使你的<code>mod_rewrite</code>规则能够工作，你需要在<strong>“/etc/apache2/sites-available/000-default-le-ssl.conf”</strong> 安装配置你的证书。 另外，要启用<code>SSL ProxyPass</code>引擎，相关配置如下：</p>
<pre><code class="hljs c"># Enable the Proxy Engine
SSLProxyEngine On

# Tell the Proxy Engine where to forward your requests
ProxyPass / https://DESTINATION_C2_URL:443/
ProxyPassReverse / https://DESTINATION_C2_URL:443/

# Disable Cert checking, useful if you're using a self-signed cert
SSLProxyCheckPeerCN off
SSLProxyCheckPeerName off
SSLProxyCheckPeerExpire off
</code></pre>

<h3 id="4-3-7-其他-Apache-mod-rewrite-资源"><a href="#4-3-7-其他-Apache-mod-rewrite-资源" class="headerlink" title="4.3.7 其他 Apache mod_rewrite 资源"></a>4.3.7 其他 Apache mod_rewrite 资源</h3><ul>
<li><a href="https://posts.specterops.io/automating-apache-mod-rewrite-and-cobalt-strike-malleable-c2-profiles-d45266ca642" target="_blank" rel="noopener">Automating Apache mod_rewrite and Cobalt Strike Profiles</a></li>
<li><a href="http://mod-rewrite-cheatsheet.com/" target="_blank" rel="noopener">mod-rewrite-cheatsheet.com</a></li>
<li><a href="http://httpd.apache.org/docs/current/rewrite/" target="_blank" rel="noopener">Official Apache 2.4 mod_rewrite Documentation</a></li>
<li><a href="https://httpd.apache.org/docs/2.4/en/rewrite/intro.html" target="_blank" rel="noopener">Apache mod_rewrite Introduction</a></li>
<li><a href="http://code.tutsplus.com/tutorials/an-in-depth-guide-to-mod_rewrite-for-apache--net-6708" target="_blank" rel="noopener">An In-Depth Guide to mod_rewrite for Apache</a></li>
<li><a href="http://www.htaccesscheck.com/" target="_blank" rel="noopener">Mod_Rewrite/.htaccess Syntax Checker</a></li>
</ul>
<h1 id="五、修改-C2-流量"><a href="#五、修改-C2-流量" class="headerlink" title="五、修改 C2 流量"></a>五、修改 C2 流量</h1><h2 id="5-1-Cobalt-Strike"><a href="#5-1-Cobalt-Strike" class="headerlink" title="5.1 Cobalt Strike"></a>5.1 Cobalt Strike</h2><p><code>Cobalt Strike</code>通过<code>Malleable C2</code>配置文件修改其流量。 配置文件提供了高度可定制的选项，用于修改服务器的<code>C2</code>流量在线路上的形式。 <code>Malleable C2</code>配置文件可增加强事件响应的规避，使用的合法内部应用程序冒充已知对手或伪装目标。</p>
<ul>
<li><a href="https://github.com/rsmudge/Malleable-C2-Profiles" target="_blank" rel="noopener">Malleable C2 Profiles - GitHub</a></li>
<li><a href="https://www.cobaltstrike.com/help-malleable-c2" target="_blank" rel="noopener">Malleable Command and Control Documentation - cobaltstrike.com</a></li>
<li><a href="http://blog.cobaltstrike.com/2014/07/16/malleable-command-and-control/" target="_blank" rel="noopener">Cobalt Strike 2.0 - Malleable Command and Control - Raphael Mudge</a></li>
<li><a href="http://blog.cobaltstrike.com/2016/12/08/cobalt-strike-3-6-a-path-for-privilege-escalation/" target="_blank" rel="noopener">Cobalt Strike 3.6 - A Path for Privilege Escalation - Raphael Mudge</a></li>
<li><a href="http://www.harmj0y.net/blog/redteaming/a-brave-new-world-malleable-c2/" target="_blank" rel="noopener">A Brave New World: Malleable C2 - Will Schroeder (@harmj0y)</a></li>
<li><a href="https://bluescreenofjeff.com/2017-01-24-how-to-write-malleable-c2-profiles-for-cobalt-strike/" target="_blank" rel="noopener">How to Write Malleable C2 Profiles for Cobalt Strike - Jeff Dimmock</a></li>
</ul>
<h2 id="5-2-Empire"><a href="#5-2-Empire" class="headerlink" title="5.2 Empire"></a>5.2 Empire</h2><p><code>Empire</code>可以用使用<code>Communication Profile</code>定制配置，它可以提供对 URI、User-Agent、Header定制选项。 profile 文件由每个由管道符(|)分隔元素，并使用<code>listeners</code>上下文菜单中的<code>set DefaultProfile</code>进行设置。</p>
<p>以下是一个示例 Profile：</p>
<pre><code class="hljs c">"/CWoNaJLBo/VTNeWw11212/|Mozilla/4.0 (compatible; MSIE 6.0;Windows NT 5.1)|Accept:image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*|Accept-Language:en-en"
</code></pre>

<p><code>DefaultProfile</code>的值可以通过<code>Empire</code>的初始化之前修改<code>/setup/setup_database.py</code>来设置。除通过<code>Communication Profile</code>之外，你可以考虑按照Joe Vest’s(<a href="https://twitter.com/joevest" target="_blank" rel="noopener">@joevest</a>)发布的步骤定制<code>Empire</code>服务器的 URI、服务器头和默认网页内容<a href="http://threatexpress.com/2017/05/empire-modifying-server-c2-indicators/" target="_blank" rel="noopener">Empire - Modifying Server C2 Indicators</a>。</p>
<ul>
<li><a href="https://github.com/EmpireProject/Empire/tree/master/data/profiles" target="_blank" rel="noopener">Default Empire Communication Profiles (in Empire GitHub repo)</a></li>
<li><a href="https://bluescreenofjeff.com/2017-03-01-how-to-make-communication-profiles-for-empire/" target="_blank" rel="noopener">How to Make Communication Profiles for Empire - Jeff Dimmock</a></li>
</ul>
<h1 id="六、第三方-C2-频道"><a href="#六、第三方-C2-频道" class="headerlink" title="六、第三方 C2 频道"></a>六、第三方 C2 频道</h1><p>自己创建一个可信的合法化的 Web 服务用于<code>C2</code>，这需要你有足够的相关知识储备，而且使用的技术越来越复杂，运维管理的时间也越来越高。这里介绍一种利用第三方服务<code>Domain Fronting</code>进行<code>C2</code>重定向。</p>
<h2 id="6-1-Domain-Fronting"><a href="#6-1-Domain-Fronting" class="headerlink" title="6.1 Domain Fronting"></a>6.1 Domain Fronting</h2><p><code>Domain Fronting</code>是一种被审查制度规避服务和应用程序用于通过合法和高度信任的域进行流量传输的技术。 支持<code>Domain Fronting</code>的热门服务包括<a href="https://cloud.google.com/appengine/" target="_blank" rel="noopener">Google App Engine</a>、<a href="https://aws.amazon.com/cloudfront/" target="_blank" rel="noopener">Amazon CloudFront</a>和<a href="https://azure.microsoft.com/" target="_blank" rel="noopener">Microsoft Azure</a>。 简而言之，流量使用受信任的服务提供商的<code>DNS</code>和<code>SNI</code>名称。拿 Google 举一个例子，当边缘服务器接收到流量时（例如：位于gmail.com）数据将被转发到数据包的主机头中指定的原始服务器（例如：phish.appspot.com），根据服务提供商的不同，原始服务器会直接将流量转发到指定的域，这里可以是我们的(C2)服务器或者使用代理应用来执行最终跳转。</p>
<p><img src="/images/redteam-infrastructure/domain-fronting.png" alt="Domain Fronting Overview"></p>
<p>有关<code>Domain Fronting</code>工作原理的更多详细信息，请参阅白皮书<a href="https://www.bamsoftware.com/papers/fronting/" target="_blank" rel="noopener">Blocking-resistant communication through domain fronting</a>和TOR项目<a href="https://trac.torproject.org/projects/tor/wiki/doc/meek" target="_blank" rel="noopener">meek documentation</a>。除了标准的 frontable 域名（如任何google.com域名）之外，还可以利用其他合法域名作为前端。</p>
<p>有关前沿领域的更多信息，请查看：</p>
<ul>
<li><a href="https://www.mdsec.co.uk/2017/02/domain-fronting-via-cloudfront-alternate-domains/" target="_blank" rel="noopener">Domain Fronting via Cloudfront Alternate Domains - Vincent Yiu (@vysecurity)</a></li>
<li><a href="https://theobsidiantower.com/2017/07/24/d0a7cfceedc42bdf3a36f2926bd52863ef28befc.html" target="_blank" rel="noopener">Finding Domain frontable Azure domains - thoth / Fionnbharr (@a_profligate)</a></li>
<li><a href="https://groups.google.com/forum/#!topic/traffic-obf/7ygIXCPebwQ" target="_blank" rel="noopener">Google Groups: Blog post on finding 2000+ Azure domains using Censys</a></li>
<li><a href="https://github.com/rvrsh3ll/FindFrontableDomains" target="_blank" rel="noopener">FindFrontableDomains tool - Steve Borosh (@rvrsh3ll)</a></li>
</ul>
<h3 id="关于-Domain-Fronting-更多资讯"><a href="#关于-Domain-Fronting-更多资讯" class="headerlink" title="关于 Domain Fronting 更多资讯"></a>关于 Domain Fronting 更多资讯</h3><ul>
<li><a href="https://medium.com/@malcomvetter/simplifying-domain-fronting-8d23dcb694a0" target="_blank" rel="noopener">Simplifying Domain Fronting - Tim Malcomvetter (@malcomvetter)</a></li>
<li><a href="https://blog.cobaltstrike.com/2017/02/06/high-reputation-redirectors-and-domain-fronting/" target="_blank" rel="noopener">High-reputation Redirectors and Domain Fronting - Raphael Mudge</a></li>
<li><a href="https://www.xorrior.com/Empire-Domain-Fronting/" target="_blank" rel="noopener">Empire Domain Fronting - Chris Ross (@xorrior)</a></li>
<li><a href="https://www.optiv.com/blog/escape-and-evasion-egressing-restricted-networks" target="_blank" rel="noopener">Escape and Evasion Egressing Restricted Networks - Tom Steele (@_tomsteele) and Chris Patten</a></li>
<li><a href="https://www.cyberark.com/threat-research-blog/red-team-insights-https-domain-fronting-google-hosts-using-cobalt-strike/" target="_blank" rel="noopener">Red Team Insights on HTTPS Domain Fronting Google Hosts Using Cobalt Strike</a> - <a href="https://www.cyberark.com" target="_blank" rel="noopener">Will Vandevanter and Shay Nahari of CyberArk</a></li>
<li><a href="http://www.rvrsh3ll.net/blog/offensive/ssl-domain-fronting-101/" target="_blank" rel="noopener">SSL Domain Fronting 101 - Steve Borosh (@424f424f)</a></li>
<li><a href="https://www.peew.pw/blog/2018/2/22/how-i-identified-93k-domain-frontable-cloudfront-domains" target="_blank" rel="noopener">How I Identified 93k Domain-Frontable CloudFront Domains - Chris Myers (@SWIZZLEZ_) and Barrett Adams (@PEEWPW)</a></li>
<li><a href="https://medium.com/@vysec.private/domain-fronting-who-am-i-3c982ccd52e6" target="_blank" rel="noopener">Domain Fronting: Who Am I? - Vincent Yiu (@vysecurity)</a></li>
<li><a href="https://medium.com/@vysec.private/validated-cloudfront-ssl-domains-27895822cea3" target="_blank" rel="noopener">Validated CloudFront SSL Domains - Vincent Yiu (@vysecurity)</a></li>
<li><a href="https://www.mindpointgroup.com/blog/pen-test/cloudfront-hijacking/" target="_blank" rel="noopener">CloudFront Hijacking</a> - <a href="https://twitter.com/disloops" target="_blank" rel="noopener">Matt Westfall (@disloops)</a></li>
<li><a href="https://github.com/MindPointGroup/cloudfrunt" target="_blank" rel="noopener">CloudFrunt GitHub Repo</a> - <a href="https://github.com/MindPointGroup" target="_blank" rel="noopener">MindPointGroup</a></li>
<li><a href="https://chigstuff.com/blog/metasploit-domain-fronting-with-microsoft-azure/" target="_blank" rel="noopener">Metasploit Domain Fronting With Microsoft Azure (@ch1gg1ns)</a></li>
</ul>
<h2 id="6-2-PaaS-转向器"><a href="#6-2-PaaS-转向器" class="headerlink" title="6.2 PaaS 转向器"></a>6.2 PaaS 转向器</h2><p>许多<code>PaaS</code>和<code>SaaS</code>提供商为应用实例提供了一个静态子域或 URL 的功能。 如果此服务商的域是高度可信的，则可购买的此域的<code>VPS</code>为您的<code>C2</code>基础架构提供服务。</p>
<p>要设置重定向，您需要确定将静态子域或URL作为实例的服务一部分发布。 然后，实例将需要使用网络或基于应用程序的重定向进行配置。 该实例将充当代理，之后与此文与上讨论的其他转向器类似。</p>
<p>根据服务的具体实施可能会有很大差异; 然而，对于使用Heroku的示例，请查看<a href="https://twitter.com/Killswitch_GUI" target="_blank" rel="noopener">Alex Rymdeko-Harvey (@Killswitch_GUI)</a>博客文章<a href="https://cybersyndicates.com/2017/04/expand-your-horizon-red-team/" target="_blank" rel="noopener">Expand Your Horizon Red Team – Modern SaaS C2</a>。</p>
<p>另一个值得进一步研究的有趣技术是使用<code>Amazon S3</code>的 buckets 存储用于<code>C2</code>。 可查看<a href="https://twitter.com/Sw4mp_f0x" target="_blank" rel="noopener">Andrew Luke (@Sw4mp_f0x)</a>）的帖子 <a href="https://pentestarmoury.com/2017/07/19/s3-buckets-for-good-and-evil/" target="_blank" rel="noopener">S3 Buckets for Good and Evil</a>）。 这种技术可以与<code>Empire</code>的第三方<code>C2</code>功能结合使用。</p>
<h2 id="6-3-其他第三方-C2"><a href="#6-3-其他第三方-C2" class="headerlink" title="6.3 其他第三方 C2"></a>6.3 其他第三方 C2</h2><p>过去，一些第三方服务已经被利用于<code>C2</code>(译者注：如dropbox.com、pastebin.com)。 这种方式是利用允许用户快速发布或修改内容来帮助你逃避基于信用检测的监控系统，尤其是在第三方网站普遍受到信任的情况下。</p>
<p>查看其他第三方C2选项的资源：</p>
<ul>
<li><a href="http://securityblog.gr/4434/a-stealthy-python-based-windows-backdoor-that-uses-github-as-a-cc-server/" target="_blank" rel="noopener">A stealthy Python based Windows backdoor that uses Github as a C&amp;C server</a> - <a href="http://securityblog.gr/author/gkarpouzas/" target="_blank" rel="noopener">maldevel at securityblog.gr</a></li>
<li><a href="https://www.cobaltstrike.com/help-externalc2" target="_blank" rel="noopener">External C2 (Third-Party Command and Control) - Cobalt Strike Documentation</a></li>
<li><a href="https://outflank.nl/blog/2017/09/17/blogpost-cobalt-strike-over-external-c2-beacon-home-in-the-most-obscure-ways/" target="_blank" rel="noopener">Cobalt Strike over external C2 – beacon home in the most obscure ways</a> - <a href="https://outflank.nl/blog/author/mark/" target="_blank" rel="noopener">Mark Bergman at outflank.nl</a></li>
<li><a href="https://labs.mwrinfosecurity.com/blog/tasking-office-365-for-cobalt-strike-c2" target="_blank" rel="noopener">“Tasking” Office 365 for Cobalt Strike C2</a> - <a href="https://twitter.com/william_knows" target="_blank" rel="noopener">William Knowles (@william_knows)</a></li>
<li><a href="https://github.com/ryhanson/ExternalC2/" target="_blank" rel="noopener">External C2 for Cobalt Strike</a> - <a href="https://twitter.com/ryhanson" target="_blank" rel="noopener">Ryan Hanson (@ryhanson)</a></li>
<li><a href="http://www.insomniacsecurity.com/2018/01/11/externalc2.html" target="_blank" rel="noopener">External C2 framework for Cobalt Strike</a> - <a href="https://twitter.com/und3rf10w" target="_blank" rel="noopener">Jonathan Echavarria (@Und3rf10w)</a></li>
<li><a href="https://github.com/Und3rf10w/external_c2_framework" target="_blank" rel="noopener">External C2 framework (GitHub Repo)</a> - <a href="https://twitter.com/und3rf10w" target="_blank" rel="noopener">Jonathan Echavarria (@Und3rf10w)</a></li>
<li><a href="https://rhinosecuritylabs.com/aws/hiding-cloudcobalt-strike-beacon-c2-using-amazon-apis/" target="_blank" rel="noopener">Hiding in the Cloud:<br>Cobalt Strike Beacon C2 using Amazon APIs</a> - <a href="https://rhinosecuritylabs.com" target="_blank" rel="noopener">Rhino Security Labs</a></li>
<li><a href="https://blog.xpnsec.com/exploring-cobalt-strikes-externalc2-framework/" target="_blank" rel="noopener">Exploring Cobalt Strike’s ExternalC2 framework</a> - <a href="https://twitter.com/_xpn_" target="_blank" rel="noopener">Adam (@<em>xpn</em>)</a></li>
</ul>
<h1 id="七、隐蔽基础设施"><a href="#七、隐蔽基础设施" class="headerlink" title="七、隐蔽基础设施"></a>七、隐蔽基础设施</h1><p>用来攻击的基础架构通常易于识别，要让它看起来想一个合法的服务器，我们需要采取一些措施来增强与目标组织或目标可能使用的服务之间的迷惑性。</p>
<p>转向器(Redirectors)可以通过<a href="https://bluescreenofjeff.com/2016-03-29-invalid-uri-redirection-with-apache-mod_rewrite/" target="_blank" rel="noopener">redirecting invalid URIs</a>、<a href="https://bluescreenofjeff.com/2016-04-19-expire-phishing-links-with-apache-rewritemap/" target="_blank" rel="noopener">expiring phishing payload links</a>或<a href="https://bluescreenofjeff.com/2016-04-12-combatting-incident-responders-with-apache-mod_rewrite/" target="_blank" rel="noopener">blocking common incident responder techniques</a>; 但是，还应该注意潜在的主机及其指标。</p>
<p>例如，在<a href="http://securesql.info/hacks/2017/4/5/fall-of-an-empire" target="_blank" rel="noopener">Fall of an Empire</a>文章中 John Menerick（<a href="https://twitter.com/Lord_SQL" target="_blank" rel="noopener">@Lord_SQL</a>）罗列了在互联网上检测<code>Empire</code>服务器的方法。为了对抗这些容易被识别的指标，最好的办法就是采用修改<code>C2</code>流量模式(见本文“修改 C2 流量”部分)，修改服务器入口页面、限制打开的端口并修改默认的响应头。</p>
<p>有关如何为多种攻击框架执行这些和其他策略的更多详细信息，请查看这些帖子：</p>
<ul>
<li><a href="http://threatexpress.com/2017/05/empire-modifying-server-c2-indicators/" target="_blank" rel="noopener">Empire – Modifying Server C2 Indicators</a> - <a href="https://twitter.com/andrewchiles" target="_blank" rel="noopener">Andrew Chiles</a></li>
<li><a href="http://www.chokepoint.net/2017/04/hunting-red-team-empire-c2.html" target="_blank" rel="noopener">Hunting Red Team Empire C2 Infrastructure</a> - <a href="http://www.chokepoint.net/" target="_blank" rel="noopener">chokepoint.net</a></li>
<li><a href="http://www.chokepoint.net/2017/04/hunting-red-team-meterpreter-c2.html" target="_blank" rel="noopener">Hunting Red Team Meterpreter C2 Infrastructure</a> - <a href="http://www.chokepoint.net/" target="_blank" rel="noopener">chokepoint.net</a></li>
<li><a href="https://www.tenable.com/blog/identifying-empire-http-listeners" target="_blank" rel="noopener">Identifying Empire HTTP Listeners (Tenable Blog)</a> - <a href="https://www.tenable.com/profile/jacob-baines" target="_blank" rel="noopener">Jacob Baines</a></li>
</ul>
<h1 id="八、保护基础设施"><a href="#八、保护基础设施" class="headerlink" title="八、保护基础设施"></a>八、保护基础设施</h1><p>攻击基础架构也可能会受到与任何其他联网主机相同的攻击，并且由于正在使用的数据和连接到目标环境中，这些都被视为高度敏感的。</p>
<p>在2016年，远程代码执行漏洞被披露在最常见的攻击工具上：</p>
<ul>
<li><a href="https://github.com/justinsteven/advisories/blob/master/2016_metasploit_rce_static_key_deserialization.md" target="_blank" rel="noopener">2016 Metasploit RCE Static Key Deserialization</a></li>
<li><a href="https://github.com/justinsteven/advisories/blob/master/2017_metasploit_meterpreter_dir_traversal_bugs.md" target="_blank" rel="noopener">2017 Metasploit Meterpreter Dir Traversal Bugs</a></li>
<li><a href="http://www.harmj0y.net/blog/empire/empire-fails/" target="_blank" rel="noopener">Empire Fails - Will Schroeder</a></li>
<li><a href="http://blog.cobaltstrike.com/2016/10/03/cobalt-strike-3-5-1-important-security-update/" target="_blank" rel="noopener">Cobalt Strike 3.5.1 Important Security Update - Raphael Mudge</a></li>
</ul>
<p><strong>iptables</strong></p>
<p>应该用于过滤不需要的流量并限制所需基础架构模块之间的流量。 例如，如果<code>Cobalt Strike</code>服务器仅将资产提供给<code>Apache</code>转向器，那么<code>iptables</code>规则应该只允许来自转向器源<code>IP</code>的 80 端口。 这对于任何运维管理都尤为重要，如<code>SSH</code>或<code>Cobalt Strike</code>的默认端口50050 还要考虑阻止非目标国家 IP。 作为替代，请考虑使用由 VPS 提供商提供的管理程序防火墙。 如：Digital Ocean提供可以保护一个或多个资产的 <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-digitalocean-cloud-firewalls" target="_blank" rel="noopener">Cloud Firewalls</a>云防护。</p>
<p><strong>chattr</strong></p>
<p>可以在团队服务器上使用，以防止修改<code>cron</code>目录。 使用<code>chattr</code>你可以限制任何用户（包括root）在修改文件之前删除<code>chattr</code>属性。</p>
<p><strong>SSH</strong></p>
<p>应仅限于公钥认证，并配置为使用受限权限的用户进行初始登录。 为了增加安全性，请考虑将双因子验证添加到 SSH。</p>
<p><strong>更新升级</strong></p>
<p>定期更新系统升级漏洞补丁也是非常重要的。</p>
<p>当然，这份清单并不详尽，你可以做什么来保护团队服务器。 可参考下面的常见强化实践：</p>
<ul>
<li><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/pdf/Security_Guide/Red_Hat_Enterprise_Linux-6-Security_Guide-en-US.pdf" target="_blank" rel="noopener">Red Hat Enterprise Linux 6 Security Guide</a></li>
<li><a href="https://wiki.debian.org/Hardening" target="_blank" rel="noopener">Debian Documentation on Hardening</a></li>
<li><a href="https://www.debian.org/doc/manuals/securing-debian-howto/" target="_blank" rel="noopener">Securing Debian Manual</a></li>
<li><a href="https://www.cyberciti.biz/tips/linux-security.html" target="_blank" rel="noopener">20 Linux Server Hardening Security Tips - nixCraft</a></li>
<li><a href="https://www.sans.org/score/checklists/linux" target="_blank" rel="noopener">SANS Linux Security Checklists</a></li>
<li><a href="https://blog.obscuritylabs.com/docker-command-controll-c2/" target="_blank" rel="noopener">Docker Your Command &amp; Control (C2)</a> - <a href="https://twitter.com/killswitch_gui" target="_blank" rel="noopener">Alex Rymdeko-Harvey (@killswitch_gui)</a></li>
</ul>
<h2 id="特定的加固资源"><a href="#特定的加固资源" class="headerlink" title="特定的加固资源"></a>特定的加固资源</h2><p>网上有许多可用的资源来讨论基础设施的安全配置和设计。 并非每种设计考虑都适合每种攻击基础架构，但了解可用选项和其他测试人员正在做什么很有用。</p>
<p>以下是其中一些资源：</p>
<ul>
<li><a href="https://medium.com/@malcomvetter/responsible-red-teams-1c6209fd43cc" target="_blank" rel="noopener">Responsible Red Teams - Tim MalcomVetter (@malcomvetter)</a></li>
<li><a href="https://medium.com/@malcomvetter/safe-red-team-infrastructure-c5d6a0f13fac" target="_blank" rel="noopener">Safe Red Team Infrastructure - Tim MalcomVetter (@malcomvetter)</a></li>
<li><a href="https://rastamouse.me/2018/02/red-team-infrastructure---aws-encrypted-ebs/" target="_blank" rel="noopener">Red Team Infrastructure - AWS Encrypted EBS - @_rastamouse</a></li>
</ul>
<h1 id="九、自动部署"><a href="#九、自动部署" class="headerlink" title="九、自动部署"></a>九、自动部署</h1><p>本文所讲的红队基础设施建设，真正建设时这需要耗费大量的时间来设计和实施。 而自动化可用于大大缩短部署时间，使你能够在更短的时间内部署更复杂的设置。</p>
<p>查看有关攻击基础架构自动化的这些资源:</p>
<ul>
<li><a href="https://rastamouse.me/2017/08/automated-red-team-infrastructure-deployment-with-terraform---part-1/" target="_blank" rel="noopener">Automated Red Team Infrastructure Deployment with Terraform - Part 1</a> - <a href="https://twitter.com/_RastaMouse" target="_blank" rel="noopener">@_RastaMouse</a></li>
<li><a href="https://rastamouse.me/2017/09/automated-red-team-infrastructure-deployment-with-terraform---part-2/" target="_blank" rel="noopener">Automated Red Team Infrastructure Deployment with Terraform - Part 2</a> - <a href="https://twitter.com/_RastaMouse" target="_blank" rel="noopener">@_RastaMouse</a></li>
<li><a href="https://blog.inspired-sec.com/archive/2017/04/17/Mod-Rewrite-Automatic-Setup.html" target="_blank" rel="noopener">Mod_Rewrite Automatic Setup</a> - <a href="https://twitter.com/n0pe_sled" target="_blank" rel="noopener">Julian Catrambone (@n0pe_sled)</a></li>
<li><a href="https://bneg.io/2017/11/06/automated-empire-infrastructure/" target="_blank" rel="noopener">Automated Empire Infrastructure</a> - <a href="https://twitter.com/beyondnegative" target="_blank" rel="noopener">Jeremy Johnson (@beyondnegative)</a></li>
<li><a href="http://threat.tevora.com/automating-redirector-deployment-with-ansible/" target="_blank" rel="noopener">RTOps: Automating Redirector Deployment With Ansible</a> - <a href="http://threat.tevora.com/author/e0x70i/" target="_blank" rel="noopener">Kevin Dick</a></li>
<li><a href="https://jordan-wright.com/blog/post/2018-02-04-automating-gophish-releases/" target="_blank" rel="noopener">Automating Gophish Releases With Ansible and Docker</a> - <a href="https://twitter.com/jw_sec" target="_blank" rel="noopener">Jordan Wright (@jw_sec)</a></li>
<li><a href="https://github.com/Coalfire-Research/Red-Baron" target="_blank" rel="noopener">Red Baron GitHub Repo</a> - <a href="https://twitter.com/byt3bl33d3r" target="_blank" rel="noopener">Marcello (@byt3bl33d3r)</a></li>
<li><a href="http://threatexpress.com/2018/02/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/" target="_blank" rel="noopener">Automating Apache mod_rewrite and Cobalt Strike Malleable C2 for Intelligent Redirection</a> - <a href="https://twitter.com/joevest" target="_blank" rel="noopener">Joe Vest (@joevest)</a></li>
</ul>
<h1 id="十、提示-amp-建议"><a href="#十、提示-amp-建议" class="headerlink" title="十、提示&amp;建议"></a>十、提示&amp;建议</h1><ul>
<li><p><font color="red"><strong>记录一切</strong></font> - 运行复杂的红色团队基础设施意味着许多移动部件, 务必记录每项资产的功能以及其流量的发送位置。</p>
</li>
<li><p><font color="red"><strong>在不同服务提供商和地区之间分割资产</strong></font> -<br>基础设施资产应分布在多个服务提供商和地理区域。 蓝队成员可能会针对被确认为主动攻击的提供商提高监控门槛，甚至可能彻底阻止给定的服务提供商。 注意：如果跨边界发送加密或敏感数据，请记住国际隐私法。</p>
</li>
<li><p><font color="red"><strong>不要过度设计</strong></font> - 人们很容易对先进技术感到兴奋，并想把一切都应用到目标上。 如果你正在模拟特定的敌对威胁，只能假扮利用真正的威胁使用的技术或技能。 如果你的红队会长期攻击同一目标，在你的评估中应该考虑“简单”的通过更先进的谍报工作。 红队应该循序渐进的推动蓝队向前发展，而不是将所有火力开到最大来攻击蓝队，这可能会打垮蓝队并延缓蓝队学习与向前发展的进程。</p>
</li>
<li><p><font color="red"><strong>监控日志</strong></font> - 在整个参与过程中应监视所有日志：SMTP日志、Apache日志、socat转向器上的tcpdump、iptables日志（特定于流量转发或目标过滤）、weblogs、Cobalt Strike/Empire/MSF日志。 将日志转发到日志服务器，例如<a href="https://bluescreenofjeff.com/2017-08-08-attack-infrastructure-log-aggregation-and-monitoring/" target="_blank" rel="noopener">rsyslog</a>，以便于监控。 操作员终端数据保留可能会在操作过程中用于检查历史命令的使用情况。 @Killswitch_GUI 创建了一个名为 <a href="https://github.com/killswitch-GUI/lterm" target="_blank" rel="noopener">lTerm</a> 的易于使用的程序，它将所有 bash 终端命令记录到一个中心位置。 <a href="https://github.com/killswitch-GUI/lterm" target="_blank" rel="noopener">Log all terminal output with lTerm</a></p>
</li>
</ul>
<ul>
<li><p><font color="red"><strong>设置高价值事件告警</strong></font> - 配置攻击基础架构以生成高价值事件的警报，例如新的 C2 会话或凭证捕获匹配。 实现警报的一种流行方式是通过聊天平台的API，比如 Slack，查看以下关于 Slack 警报的相关文章: <a href="https://www.swordshield.com/2016/11/slackshellbot/" target="_blank" rel="noopener">Slack Shell Bot - Russel Van Tuyl (@Ne0nd0g)</a>, <a href="http://threatexpress.com/2016/12/slack-notifications-for-cobalt-strike/" target="_blank" rel="noopener">Slack Notifications for Cobalt Strike - Andrew Chiles (@AndrewChiles)</a>, <a href="http://bluescreenofjeff.com/2017-04-11-slack-bots-for-trolls-and-work/" target="_blank" rel="noopener">Slack Bots for Trolls and Work - Jeff Dimmock (@bluscreenfojeff)</a></p>
</li>
<li><p><font color="red"><strong>指纹事件响应</strong></font> - 如果可能的话，在评估开始前尝试被动或主动地指定 IR 操作。 例如，向目标发送平庸的网络钓鱼电子邮件（使用不相关的基础架构）并监视基础架构收到的流量。 IR 团队调查可以披露关于团队如何运作以及他们使用何种基础架构的大量信息。 如果这可以在评估之前确定，则可以对其进行过滤或直接重定向。</p>
</li>
</ul>
<h1 id="感谢列表"><a href="#感谢列表" class="headerlink" title="感谢列表"></a>感谢列表</h1><p>感谢所有以下人员(按字母顺序排列)，他们贡献了包括此文中的工具、提示或链接，还有人感谢任何编写本维基引用的工具或帖子的人！</p>
<ul>
<li><a href="https://twitter.com/andrewchiles" target="_blank" rel="noopener">@andrewchiles - Andrew Chiles</a></li>
<li><a href="https://twitter.com/armitagehacker" target="_blank" rel="noopener">@armitagehacker - Raphael Mudge</a></li>
<li><a href="https://twitter.com/beyondnegative" target="_blank" rel="noopener">@beyondnegative - Jeremy Johnson</a></li>
<li><a href="https://twitter.com/bspence7337" target="_blank" rel="noopener">@bspence7337</a></li>
<li><a href="https://twitter.com/domchell" target="_blank" rel="noopener">@domchell - Dominic Chell</a></li>
<li><a href="https://twitter.com/jivoi" target="_blank" rel="noopener">@jivoi - EK</a></li>
<li><a href="https://twitter.com/joevest" target="_blank" rel="noopener">@joevest - Joe Vest</a></li>
<li><a href="https://twitter.com/killswitch_gui" target="_blank" rel="noopener">@killswitch_gui - Alex Rymdeko-Harvey</a></li>
<li><a href="https://twitter.com/ne0nd0g" target="_blank" rel="noopener">@ne0nd0g - Russel Van Tuyl</a></li>
<li><a href="https://twitter.com/n0pe_sled" target="_blank" rel="noopener">@n0pe_sled - Julian Catrambone</a></li>
<li><a href="https://twitter.com/_RastaMouse" target="_blank" rel="noopener">@_RastaMouse</a></li>
<li><a href="https://twitter.com/tifkin_" target="_blank" rel="noopener">@tifkin_ - Lee Christensen</a></li>
<li><a href="https://twitter.com/und3rf10w" target="_blank" rel="noopener">@Und3rf10w - Jonathan Echavarria</a></li>
<li><a href="https://twitter.com/vysecurity" target="_blank" rel="noopener">@vysecurity - Vincent Yiu</a></li>
<li><a href="https://twitter.com/xorrior" target="_blank" rel="noopener">@xorrior - Chris Ross</a></li>
</ul>
<p>原文地址：<a href="https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki" target="_blank" rel="noopener">Red-Team-Infrastructure-Wiki</a></p>

            </article>
            
                <div class="share">
                    <!--开启分享-->
<div class="share-component" data-disabled="google,twitter,facebook" data-description="
设计注意事项 (Design Considerati..."></div>

<script src="/js/share.min.js"></script>

                </div>    
            
            
                
<div class="comments">
	<div class="ds-thread" data-thread-key="红队网络基础设施建设" data-title="红队网络基础设施建设" data-url="http://mykings.me/2018/05/16/红队网络基础设施建设/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"mykings"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0]
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
	</script>
</div>

            
        </div>
        <div class="column one-fourth">
            
                
                


<h3>Post Directory</h3>

<div id="post-directory-module">
	<section class="post-directory">
		<p><strong class="toc-title">文章目录</strong></p>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、设计注意事项"><span class="toc-text">一、设计注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-功能分离"><span class="toc-text">1.1 功能分离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-使用转向器"><span class="toc-text">1.2 使用转向器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-设计举例"><span class="toc-text">1.3 设计举例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-更多资源"><span class="toc-text">1.4 更多资源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、域名"><span class="toc-text">二、域名</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-分类和黑名单检查资源列表"><span class="toc-text">2.1 分类和黑名单检查资源列表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、网络钓鱼设置"><span class="toc-text">三、网络钓鱼设置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-基于-Web-的钓鱼"><span class="toc-text">3.1 基于 Web 的钓鱼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Cobalt-Strike-钓鱼"><span class="toc-text">3.2 Cobalt Strike 钓鱼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-网络钓鱼框架"><span class="toc-text">3.3 网络钓鱼框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-Gophish"><span class="toc-text">3.3.1 Gophish</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-Frenzy"><span class="toc-text">3.3.2 Frenzy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-Social-Engineer-工具包"><span class="toc-text">3.3.3 Social-Engineer 工具包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-FiercePhish-formerly-FirePhish"><span class="toc-text">3.3.4 FiercePhish (formerly FirePhish)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四、转向器"><span class="toc-text">四、转向器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-SMTP-协议"><span class="toc-text">4.1 SMTP 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-Sendmail-软件"><span class="toc-text">4.1.1 Sendmail 软件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#移除之前的服务器头"><span class="toc-text">移除之前的服务器头</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置一个通用地址"><span class="toc-text">配置一个通用地址</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-Postfix-软件"><span class="toc-text">4.1.2 Postfix 软件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-DNS-协议"><span class="toc-text">4.2 DNS 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-socat-之-DNS"><span class="toc-text">4.2.1 socat 之 DNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-iptables-之-DNS"><span class="toc-text">4.2.2 iptables 之 DNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS重定向也可以在NAT后面完成"><span class="toc-text">DNS重定向也可以在NAT后面完成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-HTTP-S-协议"><span class="toc-text">4.3 HTTP(S) 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-socat-与-mod-rewrite"><span class="toc-text">4.3.1 socat 与 mod_rewrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-socat-之-HTTP"><span class="toc-text">4.3.2 socat 之 HTTP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-iptables-之-HTTP"><span class="toc-text">4.3.3 iptables 之 HTTP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-4-SSH-之-HTTP"><span class="toc-text">4.3.4 SSH 之 HTTP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-5-Payloads-与-Web-重定向"><span class="toc-text">4.3.5 Payloads 与 Web 重定向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-6-C2-重定向"><span class="toc-text">4.3.6 C2 重定向</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C2-使用-HTTPS-重定向"><span class="toc-text">C2 使用 HTTPS 重定向</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-7-其他-Apache-mod-rewrite-资源"><span class="toc-text">4.3.7 其他 Apache mod_rewrite 资源</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五、修改-C2-流量"><span class="toc-text">五、修改 C2 流量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-Cobalt-Strike"><span class="toc-text">5.1 Cobalt Strike</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Empire"><span class="toc-text">5.2 Empire</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#六、第三方-C2-频道"><span class="toc-text">六、第三方 C2 频道</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-Domain-Fronting"><span class="toc-text">6.1 Domain Fronting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#关于-Domain-Fronting-更多资讯"><span class="toc-text">关于 Domain Fronting 更多资讯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-PaaS-转向器"><span class="toc-text">6.2 PaaS 转向器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-其他第三方-C2"><span class="toc-text">6.3 其他第三方 C2</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#七、隐蔽基础设施"><span class="toc-text">七、隐蔽基础设施</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#八、保护基础设施"><span class="toc-text">八、保护基础设施</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#特定的加固资源"><span class="toc-text">特定的加固资源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#九、自动部署"><span class="toc-text">九、自动部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#十、提示-amp-建议"><span class="toc-text">十、提示&amp;建议</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#感谢列表"><span class="toc-text">感谢列表</span></a></li></ol>
	</section>
</div>
            
        </div>
    </div>
</section>

<footer class="container">
    <div class="site-footer" role="contentinfo">
        <div class="copyright left mobile-block">
           © 2017 <span title="MyKings">MyKings</span>
            <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
        </div>
        <ul class="site-footer-links right mobile-hidden">
            <li><a href="javascript:window.scrollTo(0,0)" >TOP</a></li>
        </ul>
        <a href="https://github.com/yumemor/hexo-theme-primer" target="_blank" aria-label="view source code">
            <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
        </a>
        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1261057886'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1261057886%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
    </div>
</footer>

		<script src="/js/geopattern.js"></script>
		
		<script src="/js/toc.js"></script>
		
		<script src="/js/highlight.pack.js"></script>
		<script src="/lib/fancybox/jquery.fancybox-1.3.4.pack.js"></script>
		<script src="/js/index.js"></script>
		 <script src="/js/popular_repo.js"></script> 
	</body>
</html>